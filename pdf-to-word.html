<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF è½¬ Word å·¥å…· (ä¿®å¤ç‰ˆ)</title>
    <!-- å¼•å…¥å¿…è¦çš„åº“ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js"></script>
    <script src="https://unpkg.com/docx@7.1.0/build/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f4f4f9;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
        }
        .container {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            text-align: center;
            max-width: 500px;
            width: 90%;
        }
        h1 { color: #333; margin-bottom: 1.5rem; }
        
        /* ä¿®å¤åçš„ä¸Šä¼ åŒºåŸŸæ ·å¼ */
        .upload-wrapper {
            position: relative;
            width: 100%;
            height: 150px;
            border: 2px dashed #007bff;
            border-radius: 8px;
            background-color: #f8fbff;
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: background 0.3s;
        }
        .upload-wrapper:hover {
            background-color: #e6f0ff;
        }
        
        /* è®© input è¦†ç›–æ•´ä¸ªåŒºåŸŸï¼Œä½†å®Œå…¨é€æ˜ */
        .file-input {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
            z-index: 10;
        }
        
        .upload-text {
            pointer-events: none; /* è®©æ–‡å­—ä¸é˜»æŒ¡ç‚¹å‡» */
        }

        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.3s;
            width: 100%;
            margin-top: 10px;
        }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        
        #status { margin-top: 15px; color: #666; font-size: 14px; min-height: 20px; word-break: break-all;}
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ“„ PDF è½¬ Word</h1>
    <p style="color: #666; font-size: 0.9em; margin-bottom: 20px;">çº¯æœ¬åœ°è½¬æ¢ï¼Œä¸æ¶ˆè€—æµé‡ï¼Œä¿æŠ¤éšç§ã€‚</p>
    
    <!-- ä¿®å¤åçš„ä¸Šä¼ ç»“æ„ -->
    <div class="upload-wrapper">
        <input type="file" id="pdfInput" class="file-input" accept=".pdf" onchange="handleFileSelect(event)">
        <div class="upload-text">
            <span style="font-size: 30px;">ğŸ“‚</span><br>
            <strong>ç‚¹å‡»æ­¤å¤„é€‰æ‹© PDF æ–‡ä»¶</strong>
        </div>
    </div>
    
    <div id="status">ç­‰å¾…ä¸Šä¼ æ–‡ä»¶...</div>
    <button id="convertBtn" onclick="convertPdfToWord()" disabled>å¼€å§‹è½¬æ¢å¹¶ä¸‹è½½</button>
</div>

<script>
    let selectedFile = null;
    const statusText = document.getElementById('status');
    const convertBtn = document.getElementById('convertBtn');

    // å¼ºåˆ¶æŒ‡å®š worker åœ°å€ï¼Œé˜²æ­¢è·¨åŸŸé”™è¯¯
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

    function handleFileSelect(event) {
        const file = event.target.files[0];
        if (!file) return;

        console.log("æ£€æµ‹åˆ°æ–‡ä»¶:", file.name); // è°ƒè¯•ç”¨

        if (file.type !== 'application/pdf') {
            statusText.innerText = "âŒ é”™è¯¯ï¼šè¯·åªä¸Šä¼  PDF æ–‡ä»¶";
            statusText.style.color = "red";
            convertBtn.disabled = true;
            return;
        }

        selectedFile = file;
        statusText.innerText = `âœ… å·²é€‰ä¸­: ${file.name}`;
        statusText.style.color = "green";
        convertBtn.disabled = false;
    }

    async function convertPdfToWord() {
        if (!selectedFile) {
            alert("è¯·å…ˆé€‰æ‹©æ–‡ä»¶ï¼");
            return;
        }

        convertBtn.disabled = true;
        convertBtn.innerText = "å¤„ç†ä¸­ï¼Œè¯·ç¨å€™...";
        statusText.innerText = "æ­£åœ¨è§£æ PDF (è¿™å¯èƒ½éœ€è¦å‡ ç§’é’Ÿ)...";

        try {
            const arrayBuffer = await selectedFile.arrayBuffer();
            
            // è¯»å– PDF æ–‡æ¡£
            const loadingTask = pdfjsLib.getDocument({data: arrayBuffer});
            const pdf = await loadingTask.promise;
            
            let docChildren = [];
            const totalPages = pdf.numPages;

            for (let i = 1; i <= totalPages; i++) {
                statusText.innerText = `æ­£åœ¨è½¬æ¢ç¬¬ ${i} / ${totalPages} é¡µ...`;
                
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                
                // ç®€å•çš„æ–‡å­—æ‹¼æ¥é€»è¾‘
                let paragraphText = "";
                let lastY = -1;

                textContent.items.forEach(item => {
                    // è¿™é‡Œåšä¸€ä¸ªç®€å•çš„åˆ†æ®µå¤„ç†ï¼šå¦‚æœYè½´å˜åŒ–å¤§ï¼Œå°±è®¤ä¸ºæ˜¯æ–°è¡Œ
                    if (lastY !== -1 && Math.abs(item.transform[5] - lastY) > 10) {
                         paragraphText += "\n";
                    }
                    paragraphText += item.str;
                    lastY = item.transform[5];
                });

                // å°†æå–çš„æ–‡å­—æ”¾å…¥ Word æ®µè½
                // æ³¨æ„ï¼šä¸ºäº†é¿å…ç”Ÿæˆç©ºè¡Œï¼Œè¿‡æ»¤ä¸€ä¸‹
                const lines = paragraphText.split('\n');
                lines.forEach(line => {
                    if(line.trim() !== "") {
                        docChildren.push(
                            new docx.Paragraph({
                                children: [ new docx.TextRun({ text: line, size: 24 }) ]
                            })
                        );
                    }
                });

                // æ¯ä¸€é¡µ PDF ç»“æŸåï¼Œåœ¨ Word é‡ŒåŠ ä¸ªåˆ†é¡µç¬¦
                if (i < totalPages) {
                    docChildren.push(new docx.Paragraph({ children: [new docx.PageBreak()] }));
                }
            }

            statusText.innerText = "æ­£åœ¨æ‰“åŒ… Word æ–‡ä»¶...";

            const doc = new docx.Document({
                sections: [{ properties: {}, children: docChildren }]
            });

            const blob = await docx.Packer.toBlob(doc);
            const fileName = selectedFile.name.replace('.pdf', '.docx');
            
            saveAs(blob, fileName);

            statusText.innerText = "ğŸ‰ è½¬æ¢æˆåŠŸï¼";
            convertBtn.innerText = "è½¬æ¢ä¸‹ä¸€ä¸ª";
            convertBtn.disabled = false;

        } catch (error) {
            console.error("è½¬æ¢å‡ºé”™:", error);
            statusText.innerText = "âŒ è½¬æ¢å¤±è´¥ï¼š" + error.message;
            alert("è½¬æ¢å¤±è´¥ï¼Œå¯èƒ½åŸå› ï¼š\n1. PDF æ˜¯çº¯å›¾ç‰‡æ‰«æç‰ˆï¼ˆæ— æ³•æå–æ–‡å­—ï¼‰\n2. PDF æœ‰å¯†ç ä¿æŠ¤\n3. æµè§ˆå™¨ç‰ˆæœ¬è¿‡ä½");
            convertBtn.disabled = false;
            convertBtn.innerText = "é‡è¯•";
        }
    }
</script>

</body>
</html>
